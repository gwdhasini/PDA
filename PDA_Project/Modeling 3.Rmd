---
title: "Modeling"
author: "Maria Pia El Asmar & Hasini Gunawardena"
date: "10/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Partition of Data

```{r, echo=FALSE}

row.order <- sample(c(1:1000)) # first randomize the order of the rows
german.tr <- GermanCredit[row.order[1:750],] # take the first 750 (random) rows of german for the training set
german.te <- GermanCredit[row.order[751:1000],]


```


# Decision Tree with Caret

```{r, echo=FALSE}
library(caret)
ct.caret <- train(RESPONSE ~ .,
                         data=german.tr,
                         method="rpart",
                         preProcess=c("center", "scale"),
                         trControl=trainControl(method="repeatedcv", number=10,
                         repeats=10, verboseIter=FALSE, sampling = "down")
                         )

```

  ## Best Complexity parameter 
```{r, echo=FALSE}
print(ct.caret) 
plot(ct.caret)

```

  ## Confusion Matrix
```{r, echo=FALSE}
confusionMatrix(predict.train(ct.caret, newdata = german.te), 
                german.te$RESPONSE)


``` 

  ## Tree drawing
```{r, echo=FALSE}
plot(ct.caret$finalModel)
text(ct.caret$finalModel)

```

# Neural Network with Caret


```{r, echo=FALSE, include = FALSE}
set.seed(2006)
credit.nn.caret <- train (
  form = RESPONSE ~ .,
  data = german.tr,
  method = "nnet",
  preProcess = c("center", "scale"),
  trControl = trainControl(
    method = "repeatedcv",
    number = 10,
    repeats = 10,
    verboseIter = FALSE,
    sampling = "down")
)



```


  ## Accuracy measure
  
```{r, echo=FALSE}
print(credit.nn.caret)

```

  ## Confusion Matrix
```{r, echo=FALSE}
confusionMatrix(predict.train(credit.nn.caret, newdata = german.te), 
                german.te$RESPONSE)
``` 

  ## Neural Network drawing
```{r, echo=FALSE}
library(NeuralNetTools)
plotnet(credit.nn.caret, pos_col = "darkgreen", neg_col = "darkblue")

```

# Logistic regression with caret

```{r, echo=FALSE}
credit.log.caret <-
  train(
    form = RESPONSE ~ .,
    data = german.tr,
    method = "glm",
    preProcess = c("center", "scale"),
    trControl = trainControl(
      method = "repeatedcv",
      number = 10,
      repeats = 10,
      verboseIter = FALSE,
      sampling = "down"
    )
  )


```


  ## Accuracy measure
  
```{r, echo=FALSE}
print(credit.log.caret)
summary(credit.log.caret)

```

  ## Confusion Matrix
```{r, echo=FALSE}
confusionMatrix(predict.train(credit.log.caret, newdata = german.te),
                german.te$RESPONSE)


``` 


# Discriminant Analysis

```{r, echo=FALSE}
#LDA
library(MASS)
lda.fit <- lda(RESPONSE ~ ., data = GermanCredit)
lda.fit

```


## Predictions
```{r, echo=FALSE}
lda.pred <- predict(lda.fit, GermanCredit)
names(lda.pred) 

head(lda.pred$posterior)


```

## Confusion Matrix
```{r, echo=FALSE}
lda.class <- lda.pred$class
kable(table(lda.class, GermanCredit$RESPONSE), caption = "Prediction table.")

prev.prob.lda <- data.frame(actual = GermanCredit$RESPONSE, prob = lda.pred$posterior)
prev.class.lda <- tibble(actual = GermanCredit$RESPONSE, class = lda.class)
confusionMatrix(prev.class.lda$class, prev.class.lda$actual)

```

```{r, echo=FALSE}

library(tidyverse)
library(ggthemes)
prev.prob.lda$class <- lda.class
prev.prob.lda$correct <- ifelse(prev.class.lda$actual == prev.class.lda$class, TRUE, 
    FALSE)
ggplot(prev.prob.lda, aes(x = class, fill = correct)) + 
  geom_bar(position = "dodge") + 
  scale_fill_brewer(palette = "Set1") + 
  theme_get()
```

# QDA

```{r, echo=FALSE}
qda.fit <- qda(RESPONSE ~ ., data = GermanCredit)
qda.fit

#ca me donne une erreure je comprends pas d'oÃ¹ ca viennnnnt
qda.class <- predict(qda.fit, GermanCredit$RESPONSE)$class 
table(qda.class, Direction.2005)
```
    
# KNN

```{r, echo=FALSE}


```

# Support Vector Machine 

```{r, echo=FALSE}


```

# Ensemble methods (Random Forest)

```{r, echo= FALSE}
library(randomForest)
library(funModeling)

form <- formula (RESPONSE ~.)

# Call the function:
integ_mod_1 <- data_integrity_model(data = GermanCredit, model_name = "randomForest")
integ_mod_1$data_ok

CreditRF <- randomForest(formula=form, 
                          data=german.tr, 
                          ntree=500, mtry=4, 
                          importance=TRUE, 
                          localImp=TRUE,
                          na.action=na.roughfix,
                          replace=FALSE)

print(CreditRF)

```

## Variable importance analysis
``` {r, echo=FALSE}
library(lessR)
head(round(importance(CreditRF), 2))

details(varImpPlot(CreditRF))
```

## Diagnostic model: error rate

```{r, echo = FALSE}
round(head(CreditRF$err.rate, 15), 4)

details(plot(CreditRF))

```


## Confusion matrix

```{r, echo = FALSE}
CreditRF$confusion

```


## Confusion matrix for the test set
```{r, echo = FALSE}
library(gmodels)
CreditRF.pred<-predict(CreditRF, german.te, type="class")
CreditRF.pred

table(true=GermanCredit$RESPONSE[-c(1:750)], pred=CreditRF.pred) #PIA: est ce que c est juste de faire (c(1:750))??

CrossTable(x=GermanCredit$RESPONSE[-c(1:750)], y=CreditRF.pred, prop.chisq=FALSE)

```

## RF with repeated cross-validation

```{r, echo = FALSE}
library(caret)
modelLookup(model="rf")

#ca prend beaucouuuup de temps mais a la fin ca marche ahah
system.time(
  model_rf <- caret::train(RESPONSE ~ .,
                         data=german.tr,
                         method="rf",
                         preProcess=NULL,
                         trControl=trainControl(method="repeatedcv", number=10,
                         repeats=10, verboseIter=FALSE, sampling="down")
                         )
)


model_rf

```


## Confusion matrix

```{r, echo = FALSE}
creditsRF.pred.1 <- predict(model_rf, german.te)
confusionMatrix(creditsRF.pred.1, german.te$RESPONSE)

CrossTable(x=german.te$RESPONSE, y=creditsRF.pred.1, prop.chisq=FALSE)

```





